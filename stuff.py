import pickle
import matplotlib.pyplot as plt
import numpy as np
from copy import deepcopy
import os
from keras.models import load_model

run_ids = [672]
objs = { 'box': [ '1',
                '6',
                '9',
                '13',
                '14',
                '17',
                '18',
                '22',
                '23',
                '26',
                '28*H',
                '31',
                '32',
                '33',
                '37',
                '46',
                '47',
                '55',
                '66',
                '68',
                '71',
                '73',
                '75',
                '79',
                '81',
                '90',
                '92',
                '93',
                '103',
                '108',
                '114',
                '116',
                '117',
                '118',
                '119',
                '126',
                '128',
                '129',
                '139',
                '140',
                '142',
                '143',
                '144',
                '147',
                '151',
                '152',
                '164',
                '170',
                '171',
                '173',
                '176',
                '178',
                '179',
                '182',
                '183',
                '189',
                '194',
                '195',
                '199',
                '207',
                '209',
                '213',
                '216',
                '222',
                '223',
                '225',
                '230',
                '232',
                '245',
                '246',
                '248',
                '253',
                '258',
                '262',
                '264',
                '265',
                '268',
                '277',
                '284',
                '286',
                '292',
                '293',
                '300',
                '306',
                '310',
                '315',
                '320',
                '322',
                '334',
                '347',
                '348',
                '349',
                '351',
                '357',
                '363',
                '369',
                '373',
                '377',
                '378',
                '381',
                '382',
                '392',
                '396',
                '400',
                '402',
                '405*H',
                '411',
                '413',
                '418',
                '419',
                '425',
                '434',
                '442',
                '446',
                '449',
                '454',
                '456',
                '460',
                '466',
                '469',
                '471*H',
                '473',
                '474',
                '476',
                '477',
                '483',
                '491',
                '494',
                '498*H',
                '502',
                '511',
                '517',
                '520',
                '537',
                '541',
                '543',
                '544',
                '545',
                '546',
                '547',
                '548',
                '561',
                '562',
                '563',
                '564',
                '565',
                '566',
                '567',
                '575',
                '579',
                '585',
                '591',
                '599',
                '601',
                '607',
                '619',
                '628',
                '641',
                '643',
                '649',
                '650*H',
                '653',
                '660',
                '661',
                '662',
                '663',
                '668',
                '670',
                '674',
                '675',
                '676',
                '677',
                '679',
                '688',
                '689',
                '690',
                '693',
                '695',
                '698',
                '703',
                '714',
                '725',
                '726',
                '730',
                '731',
                '737',
                '738',
                '739',
                '743',
                '745',
                '750',
                '759',
                '760',
                '765',
                '769',
                '770',
                '772',
                '775',
                '778',
                '779',
                '790',
                '791',
                '792',
                '793',
                '797',
                '801',
                '803',
                '811',
                '814',
                '819',
                '822',
                '828',
                '831',
                '838',
                '839',
                '842',
                '843'],
       'hcylinder': [ '149',
                      '167',
                      '227',
                      '274H',
                      '514H',
                      '606',
                      '672H',
                      '711H'],
       'sphere': ['59H', '651*H'],
       'vcylinder': [ '2',
                      '5',
                      '12',
                      '16',
                      '25',
                      '27',
                      '34',
                      '44',
                      '48',
                      '53',
                      '58',
                      '64',
                      '77',
                      '85',
                      '86',
                      '88',
                      '89',
                      '94',
                      '101',
                      '104',
                      '105',
                      '106',
                      '120',
                      '121',
                      '123',
                      '130',
                      '135',
                      '146H',
                      '155',
                      '156',
                      '159',
                      '165',
                      '169',
                      '174',
                      '187',
                      '188',
                      '191',
                      '193',
                      '196',
                      '197',
                      '203',
                      '212',
                      '214',
                      '217',
                      '218',
                      '219',
                      '221',
                      '224',
                      '229',
                      '235',
                      '239',
                      '241',
                      '242',
                      '251',
                      '260',
                      '263',
                      '266',
                      '267',
                      '269',
                      '270',
                      '271',
                      '272',
                      '273',
                      '275',
                      '278',
                      '279',
                      '280',
                      '282',
                      '285*H',
                      '288',
                      '297',
                      '301',
                      '302',
                      '311',
                      '312',
                      '319',
                      '330',
                      '332',
                      '335',
                      '339',
                      '340',
                      '343',
                      '356',
                      '358',
                      '361',
                      '362',
                      '365',
                      '372',
                      '374',
                      '375',
                      '383',
                      '384',
                      '390',
                      '391H',
                      '401',
                      '406',
                      '407',
                      '408',
                      '409',
                      '412',
                      '416',
                      '420',
                      '426',
                      '427',
                      '431',
                      '432',
                      '435',
                      '436',
                      '440',
                      '444',
                      '451',
                      '452',
                      '455',
                      '461',
                      '462',
                      '463',
                      '478',
                      '479',
                      '497',
                      '499',
                      '509',
                      '510',
                      '515',
                      '523',
                      '524',
                      '525',
                      '530',
                      '531',
                      '540',
                      '542',
                      '549',
                      '555',
                      '557',
                      '560',
                      '568',
                      '571',
                      '572',
                      '583',
                      '584',
                      '588',
                      '589',
                      '590',
                      '593',
                      '596',
                      '597',
                      '602',
                      '603',
                      '604',
                      '613',
                      '615',
                      '620',
                      '624',
                      '625',
                      '626',
                      '632',
                      '638',
                      '645',
                      '646',
                      '657',
                      '666',
                      '686',
                      '696',
                      '699',
                      '701',
                      '705',
                      '706',
                      '709H',
                      '710',
                      '712',
                      '719',
                      '720',
                      '724',
                      '727',
                      '728',
                      '735',
                      '746',
                      '752',
                      '753',
                      '754',
                      '757',
                      '758',
                      '761',
                      '763',
                      '766',
                      '767',
                      '773',
                      '777',
                      '782',
                      '788',
                      '802',
                      '804',
                      '806',
                      '810',
                      '818H',
                      '820H',
                      '824',
                      '836',
                      '840']}
x_scaler = pickle.load(open('/Volumes/ROSDATA/models/object_scaler.pkl', 'rb'))
y_scaler = pickle.load(open('/Volumes/ROSDATA/models/effect_scaler.pkl', 'rb'))
som = pickle.load(open('/Volumes/ROSDATA/models/push_effect_som_0.pkl', 'rb'))
nn = load_model('/Volumes/ROSDATA/models/push_nn_0.h5')
for o, rid in objs.iteritems():
    for r in rid:
        for k in run_ids:
            before_csv = '/Volumes/ROSDATA/ros_data/features/test_data/%d/push/%s/%s/0.csv' % (k, o, r)
            after_csv = '/Volumes/ROSDATA/ros_data/features/test_data/%d/push/%s/%s/1.csv' % (k, o, r)
            if os.path.exists(before_csv):
                before_features = np.genfromtxt(before_csv, delimiter=',')
                after_features = np.genfromtxt(after_csv, delimiter=',')
                break
        if np.array_equal(after_features, np.array([0.0] * 51)):
            print '%s_%s dropped' % (o, r)
            effect_features = deepcopy(before_features)
        else:
            effect_features = np.absolute(np.subtract(after_features, before_features))

        b_a = x_scaler.transform(before_features.reshape(1, -1)).flatten()
        e_a = y_scaler.transform(effect_features.reshape(1, -1)).flatten()[0:3]

        e_p = nn.predict(b_a.reshape(1,-1)).flatten()

        plt.xlabel('Effect Features')
        plt.ylabel('Value (meters)')
        my_xticks = np.array(['x', 'y', 'z'])
        x_p = np.array([0,1,2])
        plt.xticks(x_p, my_xticks)
        plt.tight_layout()
        plt.xlim(-0.25,2.25)
        plt.plot(x_p, e_p, "o")

plt.legend()
plt.show()
